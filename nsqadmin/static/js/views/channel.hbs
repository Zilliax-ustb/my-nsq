{{> warning}}
{{> error}}

<ol class="breadcrumb">
  <li><a class="link" href="{{basePath "/"}}">Streams</a>
  <li><a class="link" href="{{basePath "/topics"}}/{{urlencode topic}}">{{topic}}</a>
  <li class="active">{{name}}</li>
</ol>

<div class="row">
    <div class="col-md-6">
        <blockquote>
            <p>主题: <strong>{{topic}}</strong>
            <p>频道: <strong>{{name}}</strong>
        </blockquote>
    </div>
</div>

{{#unless nodes.length}}
<div class="row">
    <div class="col-md-6">
        <div class="alert alert-warning">
            <h4>Notice</h4> 该主题/频道没有任何生产者.
            <p>See <a class="link" href="{{basePath "/lookup"}}">查找</a> 来得到更多信息.
        </div>
    </div>
</div>
{{else}}
{{#if isAdmin}}
<div class="row channel-actions">
    <div class="col-md-2">
        <button class="btn btn-medium btn-warning" data-action="empty">清空队列</button>
    </div>
    <div class="col-md-2">
        <button class="btn btn-medium btn-danger" data-action="delete">删除频道</button>
    </div>
    <div class="col-md-2">
        {{#if paused}}
        <button class="btn btn-medium btn-success" data-action="unpause">解除频道暂停</button>
        {{else}}
        <button class="btn btn-medium btn-primary" data-action="pause">暂停频道</button>
        {{/if}}
    </div>
</div>
{{/if}}

<div class="row">
    <div class="col-md-12">
    <h4>频道</h4>
    <table class="table table-bordered table-condensed">
        <tr>
            <th>&nbsp;</th>
            <th colspan="4" class="text-center">消息队列</th>
            <th colspan="{{#if graph_active}}5{{else}}4{{/if}}" class="text-center">Statistics</th>
            {{#if e2e_processing_latency.percentiles.length}}
            <th colspan="{{e2e_processing_latency.percentiles.length}}">E2E Processing Latency</th>
            {{/if}}
        </tr>
        <tr>
            <th>NSQd 地址</th>
            <th>深度</th>
            <th>内存 + 磁盘 消息数量</th>
            <th>正在处理消息数量</th>
            <th>推迟消息数量</th>
            <th>重新排队消息数量</th>
            <th>超时消息数量</th>
            <th>已完成消息数量</th>
            {{#if graph_active}}<th>Rate</th>{{/if}}
            <th>已连接时长</th>
            {{#each e2e_processing_latency.percentiles}}
                <th>{{floatToPercent quantile}}<sup>{{percSuffix quantile}}</sup></th>
            {{/each}}
        </tr>
        {{#each nodes}}
        <tr>
            <td>
                {{#if show_broadcast_address}}
                {{hostname_port}} (<a class="link" href="{{basePath "/nodes"}}/{{node}}">{{node}}</a>)
                {{else}}
                <a class="link" href="{{basePath "/nodes"}}/{{node}}">{{hostname_port}}</a>
                {{/if}}
                {{#if paused}} <span class="label label-primary">paused</span>{{/if}}
            </td>
            <td>{{commafy depth}}</td>
            <td>{{commafy memory_depth}} + {{commafy backend_depth}}</td>
            <td>{{commafy in_flight_count}}</td>
            <td>{{commafy deferred_count}}</td>
            <td>{{commafy requeue_count}}</td>
            <td>{{commafy timeout_count}}</td>
            <td>{{commafy message_count}}</td>
            {{#if ../graph_active}}
                <td class="bold rate" target="{{rate "topic" node topic_name ""}}"></td>
            {{/if}}
            <td>{{commafy client_count}}</td>
            {{#if e2e_processing_latency.percentiles.length}}
                {{#each e2e_processing_latency.percentiles}}
                <td>
                    <span title="{{floatToPercent quantile}}: min = {{nanotohuman min}}, max = {{nanotohuman max}}">{{nanotohuman average}}</span>
                </td>
                {{/each}}
            {{/if}}
        </tr>
        {{#if ../graph_active}}
        <tr class="graph-row">
            <td></td>
            <td><a href="{{large_graph "channel" node topic_name channel_name "depth"}}"><img width="120" height="20"  src="{{sparkline "channel" node topic_name channel_name "depth"}}"></a></td>
            <td></td>
            <td><a href="{{large_graph "channel" node topic_name channel_name "in_flight_count"}}"><img width="120" height="20"  src="{{sparkline "channel" node topic_name channel_name "in_flight_count"}}"></a></td>
            <td><a href="{{large_graph "channel" node topic_name channel_name "deferred_count"}}"><img width="120" height="20"  src="{{sparkline "channel" node topic_name channel_name "deferred_count"}}"></a></td>
            <td><a href="{{large_graph "channel" node topic_name channel_name "requeue_count"}}"><img width="120" height="20"  src="{{sparkline "channel" node topic_name channel_name "requeue_count"}}"></a></td>
            <td><a href="{{large_graph "channel" node topic_name channel_name "timeout_count"}}"><img width="120" height="20"  src="{{sparkline "channel" node topic_name channel_name "timeout_count"}}"></a></td>
            <td><a href="{{large_graph "channel" node topic_name channel_name "message_count"}}"><img width="120" height="20"  src="{{sparkline "channel" node topic_name channel_name "message_count"}}"></a></td>
            <td></td>
            <td><a href="{{large_graph "channel" node topic_name channel_name "clients"}}"><img width="120" height="20"  src="{{sparkline "channel" node topic_name channel_name "clients"}}"></a></td>
            {{#if e2e_processing_latency.percentiles.length}}
            <td colspan="{{e2e_processing_latency.percentiles.length}}">
                <a href="{{large_graph "e2e" node e2e_processing_latency "" "e2e_processing_latency"}}"><img width="120" height="20" src="{{sparkline "e2e" node e2e_processing_latency "" "e2e_processing_latency"}}"></a>
            </td>
            {{/if}}
        </tr>
        {{/if}}
        {{/each}}
        <tr class="info">
            <td>Total:</td>
            <td>{{commafy depth}}</td>
            <td>{{commafy memory_depth}} + {{commafy backend_depth}}</td>
            <td>{{commafy in_flight_count}}</td>
            <td>{{commafy deferred_count}}</td>
            <td>{{commafy requeue_count}}</td>
            <td>{{commafy timeout_count}}</td>
            <td>{{commafy message_count}}</td>
            {{#if graph_active}}
                <td class="bold rate" target="{{rate "topic" node topic_name ""}}"></td>
            {{/if}}
            <td>{{commafy client_count}}</td>
            {{#if e2e_processing_latency.percentiles.length}}
                {{#each e2e_processing_latency.percentiles}}
                <td>
                    <span title="{{floatToPercent quantile}}: min = {{nanotohuman min}}, max = {{nanotohuman max}}">{{nanotohuman average}}</span>
                </td>
                {{/each}}
            {{/if}}
        </tr>
        {{#if graph_active}}
        <tr class="graph-row">
            <td></td>
            <td><a href="{{large_graph "channel" node topic_name channel_name "depth"}}"><img width="120" height="20"  src="{{sparkline "channel" node topic_name channel_name "depth"}}"></a></td>
            <td></td>
            <td><a href="{{large_graph "channel" node topic_name channel_name "in_flight_count"}}"><img width="120" height="20"  src="{{sparkline "channel" node topic_name channel_name "in_flight_count"}}"></a></td>
            <td><a href="{{large_graph "channel" node topic_name channel_name "deferred_count"}}"><img width="120" height="20"  src="{{sparkline "channel" node topic_name channel_name "deferred_count"}}"></a></td>
            <td><a href="{{large_graph "channel" node topic_name channel_name "requeue_count"}}"><img width="120" height="20"  src="{{sparkline "channel" node topic_name channel_name "requeue_count"}}"></a></td>
            <td><a href="{{large_graph "channel" node topic_name channel_name "timeout_count"}}"><img width="120" height="20"  src="{{sparkline "channel" node topic_name channel_name "timeout_count"}}"></a></td>
            <td><a href="{{large_graph "channel" node topic_name channel_name "message_count"}}"><img width="120" height="20"  src="{{sparkline "channel" node topic_name channel_name "message_count"}}"></a></td>
            <td></td>
            <td><a href="{{large_graph "channel" node topic_name channel_name "clients"}}"><img width="120" height="20"  src="{{sparkline "channel" node topic_name channel_name "clients"}}"></a></td>
            {{#if e2e_processing_latency.percentiles.length}}
            <td colspan="{{e2e_processing_latency.percentiles.length}}">
                <a href="{{large_graph "e2e" node e2e_processing_latency "" "e2e_processing_latency"}}"><img width="120" height="20"  src="{{sparkline "e2e" node e2e_processing_latency "" "e2e_processing_latency"}}"></a>
            </td>
            {{/if}}
        </tr>
        {{/if}}
    </table>
    </div>
</div>
{{/unless}}

<h4>客户端连接</h4>

<div class="row">
    <div class="col-md-12">
        {{#unless clients.length}}
            <div class="alert alert-warning"><h4>Notice</h4>没有客户端连接到此频道</div>
        {{else}}
        <table class="table table-bordered table-condensed">
            <tr>
                <th>客户端地址</th>
                <th>客户端版本号</th>
                <th>属性</th>
                <th>NSQd 地址</th>
                <th>正在处理数量</th>
                <th>准备接收数量</th>
                <th>已完成数量</th>
                <th>重新排队数量</th>
                <th>已完成消息数</th>
                <th>已连接时长</th>
            </tr>
            {{#each clients}}
            <tr>
                <td title="{{remote_address}}">{{hostname_port}}{{#if show_client_id}} ({{client_id}}){{/if}}</td>
                <td>{{#if user_agent.length}}<small>{{user_agent}}</small>{{/if}}</td>
                <td>
                    {{#if sample_rate}}
                        <span class="label label-info">Sampled {{sample_rate}}%</span>
                    {{/if}}
                    {{#if tls}}
                        <span class="label label-warning" {{#if tls_version}}title="{{tls_version}} {{tls_cipher_suite}} {{tls_negotiated_protocol}} mutual:{{tls_negotiated_protocol_is_mutual}}"{{/if}}>TLS</span>
                    {{/if}}
                    {{#if deflate}}
                        <span class="label label-default">Deflate</span>
                    {{/if}}
                    {{#if snappy}}
                        <span class="label label-primary">Snappy</span>
                    {{/if}}
                    {{#if authed}}
                        <span class="label label-success">
                        {{#if auth_identity_url}}<a href="{{auth_identity_url}}">{{/if}}
                        <span class="glyphicon glyphicon-user white" title="Authed{{#if auth_identity}} Identity:{{auth_identity}}{{/if}}"></span>
                        {{#if auth_identity_url}}</a>{{/if}}
                        </span>
                    {{/if}}
                </td>
                <td><a class="link" href="{{basePath "/nodes"}}/{{node}}">{{node}}</a></td>
                <td>{{commafy in_flight_count}}</td>
                <td>{{commafy ready_count}}</td>
                <td>{{commafy finish_count}}</td>
                <td>{{commafy requeue_count}}</td>
                <td>{{commafy message_count}}</td>
                <td>{{nanotohuman connected}}</td>
            </tr>
            {{/each}}
        </table>
        {{/unless}}
    </div>
</div>
